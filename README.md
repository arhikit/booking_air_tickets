# Поиск и бронирование авиабилетов

## Функциональные возможности

Программа предоставляет возможность выполнить следующие api-методы:

- [ ] Поиск рейсов по списку фильтров: город вылета, город прилета, дата вылета.
- [ ] Получение информации о рейсе по id рейса.
- [ ] Получение списка свободных мест рейса в разрезе классов мест.
- [ ] Оформление билета на рейс.
- [ ] Оплата билета на рейс.
- [ ] Возврат билета на рейс.
- [ ] Регистрация билета на рейс.
- [ ] Получение информации о билете по id билета.
- [ ] Получение информации о пользователе по id пользователя. В том числе получение баланса пользователя: сумма покупок и сумма накопленных бонусов.

## Схема данных

![Схема данных](https://gitlab.com/mts-teta/dive-into-golang_students_2/3-Avmor/project/raw/main/documentation/schemaDatabase.jpg)

## Схема изменения статусов билета

![Схема изменения статусов билета](https://gitlab.com/mts-teta/dive-into-golang_students_2/3-Avmor/project/raw/main/documentation/schemaStatuses.jpg)

Схема описывает варианты изменения статусов, а также временные ограничения для выполнения операций:
- Создание билета возможно не позднее, чем за 2 часа до вылета.
- Оплата билета возможна в течение 15 минут от момента создания. В противном случае билет считается отмененным (автоматического перехода в статус "Canceled" нет).
- Оплаченный билет можно вернуть, но не позднее, чем за 24 часа до вылета.
- Онлайн-регистрация оплаченных билетов выполняется не позднее, чем за 1 час до вылета, и не ранее, чем за 24 часа до вылета. Оплаченные, незарегистрированные билеты считаются закрытыми. 

## Описание api-методов

### Получение списка рейсов

Метод `GetFlights` позволяет получить список рейсов, отобранных по id города вылета, id города прилета и дате вылета (в отбор попадают все рейсы, вылетающие в данный день).

Проверки:
- по переданному `DepartureCityId` существует город
- по переданному `ArrivalCityId` существует город

Результат выполнения запроса `http://localhost:8080/api/v1/flights?departureCityId=c76146c4-0f13-449b-9000-0cd02ec060bc&arrivalCityId=8c190755-a832-4c19-9b3d-6cae81155f90&departureDate=2022-12-20`.

![GetFlights](https://gitlab.com/mts-teta/dive-into-golang_students_2/3-Avmor/project/raw/main/documentation/GetFlights.PNG)

### Получение рейса по id

Метод `GetFlightsByID` позволяет получить информацию о рейсе по переданному id рейса. Вывод аналогичен методу `GetFlights`.

### Получение списка свободных мест

Метод `GetFlightVacantSeats` позволяет получить информацию о свободных местах рейса в разрезе классов мест. Количество свободных мест определенного класса может быть меньше общего количества не назначенных мест, т.к. при оформлении билета может быть указан только класс места без выбора определенного места.

Результат выполнения запроса `http://localhost:8080/api/v1/flights/vacant_seats/02b53737-852b-43b7-a7e9-cd49bf5c2879`.

![GetFlightVacantSeats](https://gitlab.com/mts-teta/dive-into-golang_students_2/3-Avmor/project/raw/main/documentation/GetFlightVacantSeats.PNG)

### Создание билета

Метод `CreateTicket` позволяет оформить билет на рейс.

Параметры, передаваемые в теле запроса:
- `FlightId`. Идентификатор рейса
- `UserId`. Идентификатор пользователя, выполняющего оформление билета.
- `PassengerId`. Идентификатор пассажира. Заполняется, если выбран существующий пассажир, а не создается новый.
- `NamePassenger`. ФИО пассажира. Заполняется, если будет создаваться пассажир, а не выбираться существующий..
- `IdentityDataPassenger`. Паспортные данные пассажира. Заполняется, если будет создаваться пассажир, а не выбираться существующий.
- `ClassSeatsId`. Идентификатор класса места.
- `SeatId`. Идентификатор места в самолете. Заполняется, если при оформлении билета сразу покупается определенное место. В противном случае место указывается при регистрации на рейс.
- `CountAdditionalBaggage`. Количество мест дополнительного багажа.

Проверки:
- По переданному `FlightId` существует рейс.
- До вылета осталось больше 2 часов.
- По переданному `UserId` существует пользователь.
- Если передается `PassengerId`, то проверяем, что по переданному `PassengerId` существует пассажир и данный пассажир соответствует пользователю `UserId` создаваемого билета.
- Если не передается `PassengerId`, то проверяем, что заполнены параметры `NamePassenger` и `IdentityDataPassenger`.
- На данном рейсе существуют места с заданным классом `ClassSeatsId` и есть свободные места данного класса.
- Если передается `SeatId`, ты выполняется проверка данного места: место соответствует данному классу места и свободно.

Выполняемые действия:
- Производится расчет стоимости билета. Стоимость билета `Price` = стоимость билета выбранного класса `PriceTicket` + стоимость дополнительного багажа `PriceAdditionalBaggage` * количество мест дополнительного багажа `CountAdditionalBaggage` + стоимость выбора места `PriceSeatSelection`, если место было выбрано на этапе создания билета.
- Создание пассажира пользователя, если не был передан `PassengerId`, = добавление записи в таблицу `passengers`.
- Создание билета = добавление записи в таблицу `tickets`.
- Возвращается результат выполнения запроса - id созданного билета.

### Оплата билета

Метод `PayForTicket` позволяет выполнить оплату билета.

Параметры, передаваемые в теле запроса:
- `TicketId`. Идентификатор билета для оплаты.
- `UserId`. Идентификатор пользователя, выполняющего оплату билета.
- `PaidWithBonuses`. Сумма бонусов для оплаты.

Проверки:
- По переданному `TicketId` существует билет и его актуальный статус 1(Created).
- Билет создан не более 15 минут назад, иначе билет должен быть отменен.
- По переданному `UserId` существует пользователь и данный пользователь соответствует пользователю билета.
- Если передается сумма бонусов для оплаты `PaidWithBonuses`, то проверяем, что данная сумма не превышает общую сумму бонусов пользователя `SumBonuses` и не превышает половину стоимости билета `Price`.

Выполняемые действия:
- Получаем сумму бонусов `AccruedBonuses`, начисляемых за приобретение билета. Бонусы поступят на счет пользователя только после регистрации на рейс. До этого момента информация о них хранится только в билете. Расчет бонусов - % от общей суммы покупок пользователя `SumPurchases` по таблице `bonus_calc_scale`.
- Изменяются данные билета в таблице `tickets`. Билету устанавливаются: статус `status_id` = 2(Paid), время изменения статуса `status_timestamp`, сумма начисляемых бонусных баллов `accrued_bonuses`, сумма бонусов, использованных для оплаты билета `paid_with_bonuses`.
- Если для пользователя еще не заполнен баланс, то добавляется запись в таблицу `users_balance`. Сумма покупок `sum_purchases` устанавливается равной стоимости билета `price`.
- Если для пользователя уже внесен баланс в таблицу `users_balance`, то по пользователю увеличивается общая сумма покупок `sum_purchases` на стоимость билета `price`, уменьшается общая сумма бонусов `sum_bonuses` на сумму бонусов, использованную при покупке билета `paid_with_bonuses`.
- Возвращается результат выполнения запроса - id оплаченного билета.

### Возврат билета

Метод `RefundTicket` позволяет выполнить возврат билета.

Параметры, передаваемые в теле запроса:
- `TicketId`. Идентификатор возвращаемого билета.
- `UserId`. Идентификатор пользователя, выполняющего возврат билета.

Проверки:
- По переданному `TicketId` существует билет и его актуальный статус 2(Paid).
- До вылета осталось больше 24 часов.
- По переданному `UserId` существует пользователь и данный пользователь соответствует пользователю билета.
- У пользователя `UserId` заполнен баланс в таблице `users_balance`, т.к. данный билет уже был куплен и это должно быть отражено в балансе пользователя.

Выполняемые действия:
- Изменяются данные билета в таблице `tickets`. Билету устанавливаются: статус `status_id` = 4(Refunded) и время изменения статуса `status_timestamp`.
- Изменяется баланс пользователя в таблице `users_balance`. По пользователю уменьшается общая сумма покупок `sum_purchases` на стоимость билета `price` и увеличивается общая сумма бонусов `sum_bonuses` на стоимость билета `price`. Таким образом, возвращаются на баланс пользователя и сумма бонусов, использованная при покупке билета `paid_with_bonuses`, и сумма оплаченных денег за билет `ticket.Price - PaidWithBonuses`.
- Возвращается результат выполнения запроса - id возвращенного билета.

### Онлайн-регистрация на рейс

Метод `RegisterTicket` позволяет выполнить регистрацию пассажира на рейс.

Параметры, передаваемые в теле запроса:
- `TicketId`. Идентификатор регистрируемого билета.
- `UserId`. Идентификатор пользователя, выполняющего регистрацию на рейс.
- `SeatId`. Идентификатор места в самолете. Заполняется, если ранее при покупке билета не было выбрано определенное место.

Проверки:
- По переданному `TicketId` существует билет и его актуальный статус 2(Paid).
- До вылета осталось больше 1 часа и меньше 24 часов.
- По переданному `UserId` существует пользователь и данный пользователь соответствует пользователю билета.
- У пользователя `UserId` заполнен баланс в таблице `users_balance`, т.к. данный билет уже был куплен и это должно быть отражено в балансе пользователя.
- Если в билете место `SeatId` еще не заполнено, значит, место должно назначаться при регистрации на рейс. Проверяем, что в параметрах запроса место `SeatId` передается и данное место есть в списке вакантных мест рейса по классу мест `ClassSeatsId`, указанному при покупке билета.

Выполняемые действия:
- Изменяются данные билета в таблице `tickets`. Билету устанавливаются: статус `status_id` = 5(Registered), время изменения статуса `status_timestamp` и место `seat_id`, если при покупке билета место не было назначено.
- Изменяется баланс пользователя в таблице `users_balance`. По пользователю увеличивается общая сумма бонусов `sum_bonuses` на сумму начисленных за билет бонусов `accrued_bonuses`.
- Возвращается результат выполнения запроса - id зарегистрированного билета.

### Получение билета по id

Метод `GetTicketById` позволяет получить информацию о билете по переданному id билета.

Результат выполнения запроса `http://localhost:8080/api/v1/tickets/04e7fc13-fa3f-4202-8284-d47e99d277c4`.

![GetTicketById](https://gitlab.com/mts-teta/dive-into-golang_students_2/3-Avmor/project/raw/main/documentation/GetTicketById.PNG)

### Получение информации о пользователе по id.

Метод `GetUserById` позволяет получить информацию о пользователе по переданному id пользователя. Выводится информация о балансе пользователя: сумма покупок и сумма накопленных бонусов.

Результат выполнения запроса `http://localhost:8080/api/v1/users/c651e4a2-8a35-4d09-ba46-24b3975d4939`.

![GetUserById](https://gitlab.com/mts-teta/dive-into-golang_students_2/3-Avmor/project/raw/main/documentation/GetUserById.PNG)
